PREFIX=@prefix@
WSGI_USER=@with_wsgi_user@
MKDIR=mkdir
WSGI_HOMEDIR=@with_wsgi_homedir@

TAR=tar
RM=rm
CHOWN=chown
CHMOD=chmod
NPM=npm

all::
	cd gfarm-s3/console/static/console && $(NPM) install

install:
	$(TAR) cf - gfarm-s3 rungunicorn runserver | (cd $(WSGI_HOMEDIR) && $(TAR) xfp -)
	(cd gfarm-s3/console && $(TAR) cf - static) | (cd $(WSGI_HOMEDIR) && $(TAR) xfp -)
	$(CHOWN) -R $(WSGI_USER):$(WSGI_GROUP) $(WSGI_HOMEDIR)/gfarm-s3 $(WSGI_HOMEDIR)/rungunicorn $(WSGI_HOMEDIR)/runserver $(WSGI_HOMEDIR)/static
	$(CHMOD) +x $(WSGI_HOMEDIR)/rungunicorn $(WSGI_HOMEDIR)/runserver
	$(CHMOD) og+rX $(WSGI_HOMEDIR)
	$(CHMOD) -R og+rX $(WSGI_HOMEDIR)/static

clean:
	$(RM) -fr gfarm-s3/console/static/console/node_modules

distclean:
	$(RM) rungunicorn runserver
	$(RM) -f makefile
