PREFIX=@prefix@
GFARM_S3_USER=@with_gfarm_s3_user@
GFARM_S3_GROUP=@with_gfarm_s3_group@
GFARM_S3_HOMEDIR=@with_gfarm_s3_homedir@

MKDIR=mkdir
TAR=tar
RM=rm
CHOWN=chown
CHMOD=chmod
NPM=npm

all::
	cd gfarm-s3/console/static/console && $(NPM) install

install:
	$(TAR) cf - gfarm-s3 rungunicorn runserver | (cd $(GFARM_S3_HOMEDIR) && $(TAR) xfp -)
	(cd gfarm-s3/console && $(TAR) cf - static) | (cd $(GFARM_S3_HOMEDIR) && $(TAR) xfp -)
	$(CHOWN) -R $(GFARM_S3_USER):root $(GFARM_S3_HOMEDIR)/gfarm-s3 $(GFARM_S3_HOMEDIR)/rungunicorn $(GFARM_S3_HOMEDIR)/runserver $(GFARM_S3_HOMEDIR)/static
	$(CHMOD) +x $(GFARM_S3_HOMEDIR)/rungunicorn $(GFARM_S3_HOMEDIR)/runserver
	# read-only by others
	$(CHMOD) -R og-w $(GFARM_S3_HOMEDIR)
	$(CHMOD) -R og+rX $(GFARM_S3_HOMEDIR)

clean:
	$(RM) -fr gfarm-s3/console/static/console/node_modules

distclean:
	$(RM) rungunicorn runserver
	$(RM) -f makefile
