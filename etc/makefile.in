PREFIX=@prefix@

SYS_HTTPD_CONF=/etc/httpd/conf/httpd.conf
SYS_HTTPD_CONF_D=/etc/httpd/conf.d
WSGI_USER=@with_wsgi_user@

GFARMS3_CONF=$(PREFIX)/etc/gfarm-s3.conf
GFARMS3_LOCAL_USER_MAP=$(PREFIX)/etc/gfarm_s3_local_user_map
GFARMS3_USER_PORT_MAP=$(GFARM_S3_VAR)/gfarm_s3_user_port_map
GFARMS3_APACHE_REWRITE_CONF=$(GFARM_S3_VAR)/rewrite.conf
GFARM_S3_VAR=$(PREFIX)/var/gfarm-s3

INSTALL=install
MKDIR=mkdir
TOUCH=touch
CHMOD=chmod
CHOWN=chown

all: 

clean:
#	rm -f sudoers apache-gfarm-s3.conf gunicorn.service

install:
	$(INSTALL) -c gfarm-s3.conf $(GFARMS3_CONF)

	$(TOUCH) $(GFARMS3_LOCAL_USER_MAP)
	$(CHMOD) 644 $(GFARMS3_LOCAL_USER_MAP)

	$(INSTALL) -c sudoers /etc/sudoers.d/gfarm-s3
	if ! grep -q '^gfarms3:' /etc/group; then sudo groupadd gfarms3; fi

	$(MKDIR) -p $$(dirname $(GFARMS3_USER_PORT_MAP))
	$(CHOWN) $(WSGI_USER) $$(dirname $(GFARMS3_USER_PORT_MAP))
	$(TOUCH) $(GFARMS3_USER_PORT_MAP)
	$(CHOWN) $(WSGI_USER) $(GFARMS3_USER_PORT_MAP)

	$(MKDIR) -p $$(dirname $(GFARMS3_APACHE_REWRITE_CONF))
	$(CHOWN) $(WSGI_USER) $$(dirname $(GFARMS3_APACHE_REWRITE_CONF))
	$(TOUCH) $(GFARMS3_APACHE_REWRITE_CONF)
	$(CHOWN) $(WSGI_USER) $(GFARMS3_APACHE_REWRITE_CONF)

	$(INSTALL) gunicorn.service /etc/systemd/system/gunicorn.service

	@echo please add apache-gfarm-s3.conf content to your httpd.conf
	@echo systemctl enable --now gunicorn.service
