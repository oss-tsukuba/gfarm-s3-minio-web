PREFIX=@prefix@

SYS_HTTPD_CONF=/etc/httpd/conf/httpd.conf
SYS_HTTPD_CONF_D=/etc/httpd/conf.d
WSGI_USER=@with_wsgi_user@
WITH_ROUTER_HOMEDIR=@with_router_homedir@

GFARMS3_CONF_DIR=$(PREFIX)/etc
GFARMS3_LOCAL_USER_MAP=$(PREFIX)/etc/gfarm_s3_local_user_map
GFARMS3_USER_PORT_MAP=$(GFARM_S3_VAR)/gfarm_s3_user_port_map
GFARMS3_APACHE_REWRITE_CONF=$(GFARM_S3_VAR)/rewrite.conf
GFARM_S3_VAR=$(PREFIX)/var/gfarm-s3

INSTALL=install
MKDIR=mkdir
TOUCH=touch
CHMOD=chmod
CHOWN=chown
SUDO=sudo
GROUPADD=groupadd
RM=rm
#SYSTEMD_SYSTEM=/etc/systemd/system
SYSTEMD_SYSTEM=/usr/lib/systemd/system

all: 

install:
	$(INSTALL) -D -c gfarm-s3.conf $(GFARMS3_CONF_DIR)/gfarm-s3.conf

	$(TOUCH) $(GFARMS3_LOCAL_USER_MAP)
	$(CHMOD) 644 $(GFARMS3_LOCAL_USER_MAP)

	$(INSTALL) -D -c sudoers /etc/sudoers.d/gfarm-s3
	if ! grep -q '^gfarms3:' /etc/group; then $(SUDO) $(GROUPADD) gfarms3; fi

	@echo "*** NOTICE *** The installer has created a group 'gfarms3'." 1>&2
	@echo "*** NOTICE *** The installer has created a file '/etc/sudoers.d/gfarm-s3'." 1>&2
	@echo "*** NOTICE *** Please confirm content of the file." 1>&2

	$(MKDIR) -p $$(dirname $(GFARMS3_USER_PORT_MAP))
	$(CHOWN) $(WSGI_USER) $$(dirname $(GFARMS3_USER_PORT_MAP))
	$(TOUCH) $(GFARMS3_USER_PORT_MAP)
	$(CHOWN) $(WSGI_USER) $(GFARMS3_USER_PORT_MAP)

	$(MKDIR) -p $$(dirname $(GFARMS3_APACHE_REWRITE_CONF))
	$(CHOWN) $(WSGI_USER) $$(dirname $(GFARMS3_APACHE_REWRITE_CONF))
	$(TOUCH) $(GFARMS3_APACHE_REWRITE_CONF)
	$(CHOWN) $(WSGI_USER) $(GFARMS3_APACHE_REWRITE_CONF)

	$(INSTALL) -D gunicorn.service $(SYSTEMD_SYSTEM)/gunicorn.service
	$(INSTALL) -D gfarm-s3-router.service $(SYSTEMD_SYSTEM)/gfarm-s3-router.service
	$(MKDIR) -p $(WITH_ROUTER_HOMEDIR)
	$(CHOWN) $(WSGI_USER):$(WSGI_GROUP) $(WITH_ROUTER_HOMEDIR)
	$(INSTALL) -D -c -m 644 ../router/router.py $(WITH_ROUTER_HOMEDIR)
	$(CHOWN) $(WSGI_USER):$(WSGI_GROUP) $(WITH_ROUTER_HOMEDIR)/router.py

	@echo please add apache-gfarm-s3.conf content to your httpd.conf
	@echo systemctl enable --now gunicorn.service
	@echo systemctl enable --now gfarm-s3-router.service

clean:

distclean:
	$(RM) -f apache-gfarm-s3.conf gfarm-s3.conf gunicorn.service sudoers
	$(RM) -f makefile
