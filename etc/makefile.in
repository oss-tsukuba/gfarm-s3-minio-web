PREFIX=@prefix@

SYS_HTTPD_CONF=/etc/httpd/conf/httpd.conf
SYS_HTTPD_CONF_D=/etc/httpd/conf.d
GFARM_S3_USERNAME=@with_gfarm_s3_user@
GFARM_S3_GROUPNAME=@with_gfarm_s3_group@
ROUTER_HOMEDIR=@with_gfarm_s3_homedir@/gfarm-s3

GFARMS3_CONF_DIR=$(PREFIX)/etc
GFARMS3_CONF_OVERWRITE=$(GFARMS3_CONF_DIR)/gfarm-s3-overwrite.conf
GFARMS3_LOCAL_USER_MAP=$(PREFIX)/etc/gfarm_s3_local_user_map
GFARMS3_USER_PORT_MAP=$(GFARM_S3_VAR)/gfarm_s3_user_port_map
GFARMS3_APACHE_REWRITE_CONF=$(GFARM_S3_VAR)/rewrite.conf
GFARM_S3_VAR=$(PREFIX)/var/gfarm-s3

INSTALL=install
MKDIR=mkdir
TOUCH=touch
CHMOD=chmod
CHOWN=chown
SUDO=sudo
GROUPADD=groupadd
RM=rm
#SYSTEMD_SYSTEM=/etc/systemd/system
SYSTEMD_SYSTEM=/usr/lib/systemd/system

all:

install:
	$(INSTALL) -D -m 644 gfarm-s3.conf $(GFARMS3_CONF_DIR)/gfarm-s3.conf
	[ -f $(GFARMS3_CONF_OVERWRITE) ] || $(TOUCH) $(GFARMS3_CONF_OVERWRITE)
	chmod 644 $(GFARMS3_CONF_OVERWRITE)

	$(TOUCH) $(GFARMS3_LOCAL_USER_MAP)
	$(CHMOD) 644 $(GFARMS3_LOCAL_USER_MAP)

	$(INSTALL) -D -m 644 sudoers /etc/sudoers.d/gfarm-s3
	@echo "*** NOTICE *** The installer has created a file '/etc/sudoers.d/gfarm-s3'." 1>&2
	@echo "*** NOTICE *** Please confirm content of the file." 1>&2

	$(MKDIR) -p $$(dirname $(GFARMS3_USER_PORT_MAP))
	$(CHOWN) $(GFARM_S3_USERNAME) $$(dirname $(GFARMS3_USER_PORT_MAP))
	$(TOUCH) $(GFARMS3_USER_PORT_MAP)
	$(CHOWN) $(GFARM_S3_USERNAME) $(GFARMS3_USER_PORT_MAP)

	$(MKDIR) -p $$(dirname $(GFARMS3_APACHE_REWRITE_CONF))
	$(CHOWN) $(GFARM_S3_USERNAME) $$(dirname $(GFARMS3_APACHE_REWRITE_CONF))
	$(TOUCH) $(GFARMS3_APACHE_REWRITE_CONF)
	$(CHOWN) $(GFARM_S3_USERNAME) $(GFARMS3_APACHE_REWRITE_CONF)

	$(INSTALL) -D -m 644 gfarm-s3-webui.service $(SYSTEMD_SYSTEM)/gfarm-s3-webui.service
	$(INSTALL) -D -m 644 gfarm-s3-router.service $(SYSTEMD_SYSTEM)/gfarm-s3-router.service

	#@echo please add apache-gfarm-s3.conf content to your httpd.conf
	@echo systemctl enable --now gfarm-s3-webui.service
	@echo systemctl enable --now gfarm-s3-router.service

	$(INSTALL) -D -m 644 nginx-gfarm-s3.conf $(GFARMS3_CONF_DIR)/nginx-gfarm-s3.conf
	$(INSTALL) -D -m 644 nginx-gfarm-s3-generated.conf $(GFARMS3_CONF_DIR)/nginx-gfarm-s3-generated.conf

clean:

distclean:
	$(RM) -f apache-gfarm-s3.conf nginix-gfarm-s3-generated.conf gfarm-s3.conf gfarm-s3-webui.service gfarm-s3-router.service sudoers
	$(RM) -f makefile
