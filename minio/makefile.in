PREFIX=@prefix@
WITH_GFARM=/usr/local
MINIO_BUILDDIR=@with_minio_builddir@
GOPATH=$(MINIO_BUILDDIR)/minio/work/go
GOBIN=$(GOPATH)/bin
BUILDDIR=$(MINIO_BUILDDIR)/minio/work/build

GO_ARCHIVE=go1.15.linux-amd64.tar.gz
GO_URL=https://dl.google.com/go/$(GO_ARCHIVE)

MINIO_PATH=$(PREFIX)/bin/minio
MC_PATH=$(PREFIX)/bin/mc

mc_git=https://github.com/minio/mc.git
minio_git=https://github.com/oss-tsukuba/gfarm-s3-minio.git

CGO_LDFLAGS="-Wl,-rpath,$(WITH_GFARM)/lib"
PKG_CONFIG_PATH="$(WITH_GFARM)/lib/pkgconfig"

MKDIR=mkdir
CURL=curl
TAR=tar
RM=rm
GIT=git

all::
	[ -d $(BUILDDIR) ] || $(MKDIR) -p $(BUILDDIR)
	[ -d $(BUILDDIR)/mc ] || (cd $(BUILDDIR) && $(GIT) clone $(mc_git))
	[ -d $(BUILDDIR)/gfarm-s3-minio ] || (cd $(BUILDDIR) && $(GIT) clone $(minio_git) && cd gfarm-s3-minio && $(GIT) checkout gatewaygfarm && $(GIT) pull)

	cd $(BUILDDIR)/mc && GOPATH=$(GOPATH) $(GOPATH)/bin/go install

	cd $(BUILDDIR)/gfarm-s3-minio && GOPATH=$(GOPATH) CGO_LDFLAGS=$(CGO_LDFLAGS) PKG_CONFIG_PATH=$(PKG_CONFIG_PATH) $(GOPATH)/bin/go install

install-go::
	-$(MKDIR) -p $$(dirname $(GOPATH))
	cd $$(dirname $(GOPATH)) && $(CURL) $(GO_URL) | $(TAR) xfzp -

install::
	install -c -m 555 $(GOBIN)/mc "$(MC_PATH)"
	install -c -m 555 $(GOBIN)/minio "$(MINIO_PATH)"

clean::
	$(RM) -rf $(BUILDDIR)

distclean:
	$(RM) -f makefile
