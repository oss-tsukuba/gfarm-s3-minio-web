prefix=@prefix@
WITH_GFARM=/usr/local
SRCDIR=/home/user1/work/gfarm-s3-minio-web
GOPATH=$(SRCDIR)/minio/work/go
GOPATH=$(SRCDIR)/minio/work/go
GOBIN=$(GOPATH)/bin
BUILDDIR=$(SRCDIR)/minio/work/build

GO_ARCHIVE=go1.15.linux-amd64.tar.gz
GO_URL=https://dl.google.com/go/$(GO_ARCHIVE)

GFARM_S3_PREFIX=@prefix@
MINIO_PATH=$(GFARM_S3_PREFIX)/bin/minio
MC_PATH=$(GFARM_S3_PREFIX)/bin/mc

mc_git=https://github.com/minio/mc.git
minio_git=git@github.com:oss-tsukuba/gfarm-s3-minio.git

CGO_LDFLAGS="-Wl,-rpath,$(WITH_GFARM)/lib"
PKG_CONFIG_PATH="$(WITH_GFARM)/lib/pkgconfig"

MKDIR=mkdir
CURL=curl
TAR=tar

all::
	##gfarm2fs configurations:
	##--with-gfarm=/usr/local
	##--prefix=/usr/local

	###export GOPATH=$(SRCDIR)/minio/work/go
	###export GOBIN=$GOPATH/bin

	#. /usr/local/etc/gfarm-s3.conf


	[ -d $(BUILDDIR) ] || $(MKDIR) -p $(BUILDDIR)
	[ -d $(BUILDDIR)/mc ] || (cd $(BUILDDIR) && git clone $(mc_git))
	[ -d $(BUILDDIR)/gfarm-s3-minio ] || (cd $(BUILDDIR) && git clone $(minio_git) && cd gfarm-s3-minio && git checkout gatewaygfarm)

	(cd $(BUILDDIR)/mc && GOPATH=$(GOPATH) $(GOPATH)/bin/go install)

	###if [ x"$with_gfarm" = x"/usr" ]; then with_gfarm=; fi

	###set -o xtrace
	(cd $(BUILDDIR)/gfarm-s3-minio && GOPATH=$(GOPATH) CGO_LDFLAGS=$(CGO_LDFLAGS) PKG_CONFIG_PATH=$(PKG_CONFIG_PATH) $(GOPATH)/bin/go install)

install-go::
	-$(MKDIR) -p $$(dirname $GOPATH)
	(cd $$(dirname $(GOPATH)) && $(CURL) $(GO_URL) | $(TAR) xfzp -)

install::
	install -c -m 555 $(GOBIN)/mc "$(MC_PATH)"
	install -c -m 555 $(GOBIN)/minio "$(MINIO_PATH)"

clean::
	rm -rf $(BUILDDIR)
