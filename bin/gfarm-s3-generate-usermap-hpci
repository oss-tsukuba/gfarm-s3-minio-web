#! /bin/sh

parse() {
	sed 's/^"[^"]*\[\(hpci[0-9]*\)\]" \([a-zA-Z0-9_][a-zA-Z0-9_]*\)$/\1:\2:\1/'
}

debug_dummy() {
cat <<-EOF 
	"/C=JP/O=NII/OU=HPCI/CN=Given1%40Family1[hpci000001]" user1
	"/C=JP/O=NII/OU=HPCI/CN=Given2%40Family2[hpci000002]" user2
	"/C=JP/O=NII/OU=HPCI/CN=Given3%40Family3[hpci000003]" user3
EOF
}

grid_mapfile() {
	debug_dummy
	#cat /etc/grid-security/grid-mapfile
}

grid_mapfile | parse | while read gua; do
	global_username=${gua%%:*}
	local_username=${gua%:*}
	local_username=${local_username#*:}
	access_key_id=${gua##*:}
	gfarm-s3-useradd $global_username $local_username $access_key_id
done
